Include "MAPBASIC.DEF"
Include  "GET_TAB.MB"
Declare Sub SelChangedHandler
declare sub connect
declare sub disconnect
declare sub selectionlistener
declare sub errorhandler
Declare sub RemoteMsgHandler
declare sub paint
Dim ar As Integer
Dim num As Integer
dim activated as logical

activated = 0
print "Base Editror loaded"
create menu "Редактор базы" as
"&Подключиться" calling connect,
"&Отключиться" calling disconnect,
"&test" calling paint
alter menu bar add "Редактор базы"

sub selchangedhandler
	if activated = 1 then
		call selectionlistener
	end if
end sub

sub connect
	num = ddeinitiate("geobaseeditor", "areaselection")

	print "Редактор базы подключен"
	activated =1
end sub

sub disconnect
	ddeterminateall
	print "Редактор базы отключен"
	activated = 0
end sub

sub paint
    dim response as Integer


   	dim table as String
	table = GetTableName("Выберите слой", 0, 0)
	dim selectedType as SmallInt
	dim types(10) as String
	types(1) = "ОЗУ"
	types(2) = "ЦНЛ"
 	types(3) = "порода"
	types(4) = "бонитет"
	types(5) = "полнота"
	types(6) = "запас"
	types(7) = "23 макет"
	types(8) = "категория земель"

	dialog
		control popupmenu
			title from variable types into selectedType
		control OKButton
		Control CancelButton
	print selectedType
	response = Val(ddeRequest$(num, "paint"))
	shade table with Id values 1001 Brush MakeBrush(64, CYAN, BLUE)style replace off



end sub

sub selectionlistener
	onerror goto ex
	ar = selection.id
	print commandinfo(1)
	if commandinfo(1) = 1 then
		dim sq as Float
		sq = CartesianArea(selection.obj, "hectare")
		if sq = 0 then
			ddepoke num, "selection", STR$(ar)
		else
			ddepoke num, "selection_with_area", STR$(ar) + "|" + STR$(sq)
		end if
		print "end"
	end if
	exit sub
ex:
	call errorhandler
end sub

sub errorhandler
	dim code as Integer
	code = err()
	print "error " + code
	activated = 0
	if code = 696 then call disconnect
	end if
end sub

sub RemoteMsgHandler()
	'Dim data As String
	'data = CommandInfo()
	'print "requested data : " + data
End sub






