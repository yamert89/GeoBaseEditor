Include "MAPBASIC.DEF"
Include  "GET_TAB.MB"
Include "AbotLib.def"
Declare Sub Main
Declare Sub SelChangedHandler
declare sub connect
declare sub disconnect
declare sub selectionlistener
declare sub errorhandler
Declare sub RemoteMsgHandler
declare sub paint
declare sub paintrequest(req as String)
declare function parseCondition(value as String) as String

Dim ar As Integer
Dim num As Integer
Dim activated as logical
dim table as String
dim selectedStyle as Brush

sub Main
	activated = 0
	create menu "Редактор базы" as
	"&Подключиться" calling connect,
	"&Оформить" calling paint
	alter menu bar add "Редактор базы"
end sub

sub selchangedhandler
	if activated = 1 then
		call selectionlistener
	end if
end sub

sub connect
	num = ddeinitiate("geobaseeditor", "areaselection")
	print "Редактор базы подключен"
	activated =1
end sub

sub disconnect
	ddeterminateall
	print "Редактор базы отключен"
	activated = 0
end sub

sub paint

	table = GetTableName("Выберите слой", 0, 0)
	dim selectedType1, selectedType2, selectedType3, logic2, logic3 as SmallInt
    	dim types(10) as String
    	dim value1, value2, value3, condition1, condition2, condition3 as String
    	types(1) = "ОЗУ"
    	types(2) = "ЦНЛ"
     	types(3) = "порода"
    	types(4) = "бонитет"
    	types(5) = "полнота"
    	types(6) = "запас"
    	types(7) = "23 макет"
    	types(8) = "категория земель"

    	dialog title "Оформление"
    	    control statictext
    	        title "Параметр 1"
    		position 6, 7
    		control popupmenu
    			title from variable types into selectedType1
    			position 49, 5
    		control popupmenu
    		    title "=;<;>"
    			position 136, 5
    		    into condition1
    		control edittext
    			position 164, 5
    		    into value1
    		control popupmenu
    		    title "И;ИЛИ"
    		    position 6, 25
    		    into logic2
            control statictext
                title "Параметр 2"
    		    position 6, 47
            control popupmenu
                title from variable types into selectedType2
    		    position 49, 45
            control popupmenu
                title "=;<;>"
    		    position 136, 45
                into condition2
            control edittext
    		    position 164, 45
                into value2
            control popupmenu
                title "И;ИЛИ"
                position 6, 60
                into logic3
            control statictext
            	title "Параметр 3"
    		position 6, 87
            control popupmenu
                title from variable types into selectedType3
    		position 49, 85
            control popupmenu
                title "=;<;>"
    		position 136, 85
                into condition3
            control edittext
    		position 164, 85
            	into value3
    	control statictext
    		title "Выберите стиль"
    		position 6, 95
    	control BrushPicker
    		into selectedStyle
    		control OKButton
    		Control CancelButton




	dim request as String
	request = "1"+ "?" + selectedType1 + "?" + parseCondition(condition1) + "?" + value1 + "|" + logic2 + "?" + selectedType2 + "?" + parseCondition(condition2) + "?" +
	    value2 + "|" + logic3 + "?" + selectedType3 + "?" + parseCondition(condition3) + "?" + value3
	call paintrequest(request)

end sub

function parseCondition(value as String) as String
	do case value
		case "1" parseCondition = "="
		case "2" parseCondition = "<"
		case "3" parseCondition = ">"
	end case
end function



sub paintrequest(req as String)
    dim response as String
    response = ddeRequest$(num, req)
    if response = "0" then Note "Искомые выдела не найдены"
    else
	    print "response: " + response
        dim startIdx, curIdsIdx, vId, cur_size as Integer
        dim subStr as String
        dim ids(0) as Float
	    dim styles(0) as Brush
        curIdsIdx = 1
        startIdx = 1

        while startIdx < Len(response)
            subStr = Mid$(response, startIdx, 6)
            startIdx = startIdx + 7

            vId = Val(subStr)
            cur_size = UBound(ids)
            ReDim ids(cur_size + 2)
            ReDim styles(cur_size + 2)
            ids(curIdsIdx) = vId
            ids(curIdsIdx + 1) = vId
            styles(curIdsIdx) = selectedStyle
            styles(curIdsIdx + 1) = selectedStyle
            curIdsIdx = curIdsIdx + 2
        wend
        shade table with Id Ranges from variable ids style variable styles style replace off
        note "Оформлено " + cur_size + " выделов"
    end if

end sub

sub selectionlistener
	onerror goto ex
	if IsFieldExist("Selection", "Id") = false then exit sub
	end if
	ar = selection.id
	print commandinfo(1)
	if commandinfo(1) = 1 then
		dim sq as Float
		sq = CartesianArea(selection.obj, "hectare")
		if sq = 0 then
			ddepoke num, "selection", STR$(ar)
		else
			ddepoke num, "selection_with_area", STR$(ar) + "|" + STR$(sq)
		end if
	end if
	exit sub
ex:
	call errorhandler
end sub

sub errorhandler
	dim code as Integer
	code = err()
	print "error " + code
	activated = 0
	if code = 696 then call disconnect
	end if
end sub

'sub RemoteMsgHandler()
'	'Dim data As String
'	'data = CommandInfo()
'	'print "requested data : " + data
'End sub