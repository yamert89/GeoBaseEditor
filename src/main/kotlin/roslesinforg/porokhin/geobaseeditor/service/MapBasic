'Include "MAPBASIC.DEF"
Include  "GET_TAB.MB"
Declare Sub Main
Declare Sub SelChangedHandler
declare sub connect
declare sub disconnect
declare sub selectionlistener
declare sub errorhandler
Declare sub RemoteMsgHandler
declare sub paint
declare sub paintrequest(req as String)

Dim ar As Integer
Dim num As Integer
Dim activated as logical
sub Main
	activated = 0
	print "Base Editror loaded"
	create menu "Редактор базы" as
	"&Подключиться" calling connect,
	"&Отключиться" calling disconnect,
	"&test" calling paint
	alter menu bar add "Редактор базы"
end sub

sub selchangedhandler
	if activated = 1 then
		call selectionlistener
	end if
end sub

sub connect
	num = ddeinitiate("geobaseeditor", "areaselection")

	print "Редактор базы подключен"
	activated =1
end sub

sub disconnect
	ddeterminateall
	print "Редактор базы отключен"
	activated = 0
end sub

sub paint
   	dim table as String
	table = GetTableName("Выберите слой", 0, 0)
	dim selectedType1, selectedType2, selectedType3 as SmallInt
    	dim types(10) as String
    	dim value1, value2, value3, condition1, condition2, condition3 as String
    	dim selectedStyle as Brush
    	types(1) = "ОЗУ"
    	types(2) = "ЦНЛ"
     	types(3) = "порода"
    	types(4) = "бонитет"
    	types(5) = "полнота"
    	types(6) = "запас"
    	types(7) = "23 макет"
    	types(8) = "категория земель"

    	dialog title "Оформление"
    	    control statictext
    	        title "Параметр 1"
    		position 6, 7
    		control popupmenu
    			title from variable types into selectedType1
    			position 49, 5
    		control popupmenu
    		    title ">;<;="
    			position 136, 5
    		    into condition1
    		control edittext
    			position 164, 5
    		    into value1
            control statictext
                title "Параметр 2"
    		position 6, 27
            control popupmenu
                title from variable types into selectedType2
    		position 49, 25
            control popupmenu
                title ">;<;="
    		position 136, 25
                into condition2
            control edittext
    		position 164, 25
                into value2
            control statictext
            	title "Параметр 3"
    		position 6, 47
            control popupmenu
                title from variable types into selectedType3
    		position 49, 45
            control popupmenu
                title ">;<;="
    		position 136,45
                into condition3
            control edittext
    		position 164, 45
            	into value3
    	control statictext
    		title "Выберите стиль"
    	control BrushPicker
    		into selectedStyle
    		control OKButton
    		Control CancelButton


	dim request as String
	request = selectedType1 + "?" + condition1 + "?" + value1 + "|" + selectedType2 + "?" + condition2 + "?" +
	    value2 + "|" + selectedType3 + "?" + condition3 + "?" + value3
	call paintrequest(request)

end sub



sub paintrequest(req as String)
    dim response as String
    response = ddeRequest$(num, "paint")
    dim startIdx, curIdsIdx, vId, cur_size as Integer
    dim subStr as String
    dim ids(0) as Float
	dim styles(0) as Brush
    curIdsIdx = 1

    while startIdx < Len(response)
        subStr = Mid$(response, startIdx, 6)
        startIdx = startIdx + 7
        vId = Val(subStr)
        cur_size = UBound(ids)
        ReDim ids(cur_size + 2)
        ReDim styles(cur_size + 2)
        ids(curIdsIdx) = vId
        ids(curIdsIdx + 1) = vId
        styles(curIdxIdx) = MakeBrush(64, CYAN, BLUE)
        styles(curIdxIdx + 1) = MakeBrush(64, CYAN, BLUE)
        curIdsIdx = curIdsIdx + 2
    wend
    shade table with Id Ranges from variable ids style variable styles style replace off

end sub

sub selectionlistener
	onerror goto ex
	ar = selection.id
	print commandinfo(1)
	if commandinfo(1) = 1 then
		dim sq as Float
		sq = CartesianArea(selection.obj, "hectare")
		if sq = 0 then
			ddepoke num, "selection", STR$(ar)
		else
			ddepoke num, "selection_with_area", STR$(ar) + "|" + STR$(sq)
		end if
		print "end"
	end if
	exit sub
ex:
	call errorhandler
end sub

sub errorhandler
	dim code as Integer
	code = err()
	print "error " + code
	activated = 0
	if code = 696 then call disconnect
	end if
end sub

sub RemoteMsgHandler()
	'Dim data As String
	'data = CommandInfo()
	'print "requested data : " + data
End sub







